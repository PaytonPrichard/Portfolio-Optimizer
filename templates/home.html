{% extends "base.html" %}

{% block title %}MarketMosaic - Company Financial Analysis{% endblock %}

{% block content %}
<!-- Loading overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-white/80 dark:bg-gray-900/80 z-50 flex flex-col items-center justify-center hidden" role="status" aria-live="polite">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-brand border-t-transparent mb-4"></div>
    <p class="text-brand dark:text-blue-300 font-semibold text-lg" id="loading-text">Searching...</p>
    <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Fetching financial data from Yahoo Finance</p>
</div>

<div class="flex flex-col items-center justify-center min-h-[70vh] px-4">
    <h1 class="text-4xl font-bold text-brand dark:text-blue-300 mb-2">MarketMosaic</h1>
    <p class="text-gray-500 dark:text-gray-400 mb-8 text-center">Search by company name or stock ticker to get a full financial dashboard</p>

    <form action="/search" method="GET" class="w-full max-w-xl" id="search-form">
        <div class="flex shadow-lg rounded-lg overflow-hidden">
            <input
                type="text"
                name="q"
                value="{{ query or '' }}"
                placeholder="Enter company name or ticker (e.g. Apple or AAPL)"
                class="flex-1 px-6 py-4 text-lg border-0 focus:outline-none focus:ring-2 focus:ring-brand bg-white dark:bg-gray-800 dark:text-gray-200 dark:placeholder-gray-500"
                autofocus
                required
            >
            <button type="submit" class="bg-brand text-white px-8 py-4 font-semibold hover:bg-brand-dark transition">
                Analyze
            </button>
        </div>
    </form>

    <!-- Recent Searches -->
    <div id="recent-searches" class="w-full max-w-xl mt-4 hidden">
        <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-gray-400 dark:text-gray-500 uppercase tracking-wide">Recent</span>
            <button id="clear-recent" class="text-xs text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition">Clear</button>
        </div>
        <div id="recent-pills" class="flex flex-wrap gap-2"></div>
    </div>

    {% if no_results %}
    <div class="w-full max-w-xl mt-6">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg px-5 py-4">
            <p class="text-red-700 dark:text-red-400">No results found for "<strong>{{ query }}</strong>". Try a company name (e.g. "Apple") or stock ticker (e.g. "AAPL").</p>
        </div>
    </div>
    {% elif candidates %}
    <div class="w-full max-w-xl mt-6">
        <p class="text-gray-600 dark:text-gray-400 mb-3">Multiple matches found for "<strong class="dark:text-gray-200">{{ query }}</strong>". Select one:</p>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow divide-y dark:divide-gray-700">
            {% for c in candidates %}
            <a href="/dashboard/{{ c.symbol }}" class="flex items-center justify-between px-5 py-3 hover:bg-brand-light dark:hover:bg-brand/10 transition dashboard-link">
                <div>
                    <span class="font-semibold text-brand dark:text-blue-300">{{ c.symbol }}</span>
                    <span class="text-gray-600 dark:text-gray-400 ml-2">{{ c.name }}</span>
                </div>
                <span class="text-sm text-gray-400 dark:text-gray-500">{{ c.exchange }}</span>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var overlay = document.getElementById('loading-overlay');
    var loadingText = document.getElementById('loading-text');
    var RECENT_KEY = "recent_searches";
    var MAX_RECENT = 8;

    function getRecent() {
        try { return JSON.parse(localStorage.getItem(RECENT_KEY)) || []; } catch(e) { return []; }
    }

    function saveRecent(item) {
        var list = getRecent().filter(function(r) { return r.symbol !== item.symbol; });
        list.unshift(item);
        if (list.length > MAX_RECENT) list = list.slice(0, MAX_RECENT);
        localStorage.setItem(RECENT_KEY, JSON.stringify(list));
    }

    function renderRecent() {
        var list = getRecent();
        var container = document.getElementById('recent-searches');
        var pills = document.getElementById('recent-pills');
        if (!container || !pills) return;
        if (!list.length) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        var html = '';
        list.forEach(function(r) {
            html += '<a href="/dashboard/' + r.symbol + '" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-brand dark:text-blue-300 hover:bg-brand-light dark:hover:bg-brand/20 transition dashboard-recent-link">';
            html += '<span class="font-bold">' + r.symbol + '</span>';
            if (r.name) html += '<span class="text-gray-400 dark:text-gray-500 text-xs hidden sm:inline">' + r.name + '</span>';
            html += '</a>';
        });
        pills.innerHTML = html;

        // Bind overlay to recently rendered links
        pills.querySelectorAll('.dashboard-recent-link').forEach(function(link) {
            link.addEventListener('click', function() {
                var sym = this.querySelector('.font-bold').textContent;
                loadingText.textContent = 'Loading ' + sym + ' dashboard...';
                overlay.classList.remove('hidden');
            });
        });
    }

    // Clear recent
    var clearBtn = document.getElementById('clear-recent');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            localStorage.removeItem(RECENT_KEY);
            renderRecent();
        });
    }

    // Show overlay on search submit + save search
    document.getElementById('search-form').addEventListener('submit', function() {
        var q = document.querySelector('input[name="q"]').value.trim().toUpperCase();
        if (q) saveRecent({ symbol: q, name: '' });
        loadingText.textContent = 'Searching...';
        overlay.classList.remove('hidden');
    });

    // Show overlay on candidate click + save
    document.querySelectorAll('.dashboard-link').forEach(function(link) {
        link.addEventListener('click', function() {
            var tickerEl = this.querySelector('.text-brand, .dark\\:text-blue-300');
            var nameEl = this.querySelector('.text-gray-600, .dark\\:text-gray-400');
            var ticker = tickerEl ? tickerEl.textContent.trim() : '';
            var name = nameEl ? nameEl.textContent.trim() : '';
            if (ticker) saveRecent({ symbol: ticker, name: name });
            loadingText.textContent = 'Loading ' + ticker + ' dashboard...';
            overlay.classList.remove('hidden');
        });
    });

    renderRecent();
})();
</script>
{% endblock %}
